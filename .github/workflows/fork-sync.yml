name: í¬í¬ ìë™ ì‹±í¬

on:
  repository_dispatch:
    types: [ upstream-updated ]   
  workflow_dispatch:              # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  push:
    branches: [ main ]            

permissions:
  contents: write

env:
  DEFAULT_UPSTREAM: K-PaaS-Team22/shelter-web

jobs:
  sync:
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork == true }}
    steps:
      - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git ì„¤ì •
        run: |
          git config --global user.name "ìë™ ì‹±í¬ ë´‡"
          git config --global user.email "auto-sync@github.com"

      - name: upstream íƒì§€
        id: detect
        run: |
          set -e
          UPSTREAM="${{ github.event.repository.parent.full_name }}"
          [ -z "$UPSTREAM" ] && UPSTREAM="${DEFAULT_UPSTREAM}"
          echo "upstream=$UPSTREAM" >> "$GITHUB_OUTPUT"
          echo "ğŸ” upstream: $UPSTREAM"

      - name: upstream ë“±ë¡/íŒ¨ì¹˜
        run: |
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "https://github.com/${{ steps.detect.outputs.upstream }}.git"
          git fetch upstream --prune

      - name: main ë¸Œëœì¹˜ ì‹±í¬ (SHA ê¸°ì¤€ í‘¸ì‹œ)
        shell: bash
        run: |
          set -e
          git checkout main
          if git merge --ff-only upstream/main 2>/dev/null; then
            echo "â„¹ï¸ fast-forward ë³‘í•©"
          else
            git merge upstream/main --no-edit
            echo "â„¹ï¸ ì¼ë°˜ ë³‘í•©"
          fi
          LOCAL_SHA=$(git rev-parse HEAD)
          REMOTE_SHA=$(git rev-parse origin/main || echo "none")
          if [ "$LOCAL_SHA" != "$REMOTE_SHA" ]; then
            git push origin HEAD:main
            echo "âœ… main í‘¸ì‹œ ì™„ë£Œ"
          else
            echo "â„¹ï¸ main ìµœì‹  (í‘¸ì‹œ ë¶ˆí•„ìš”)"
          fi

      - name: ìš”ì•½
        run: |
          echo "ğŸ‰ ì‹±í¬ ì™„ë£Œ"
          git log --oneline -n 5
