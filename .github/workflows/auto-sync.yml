name: Auto Sync Fork with Upstream

on:
  workflow_dispatch:
    inputs:
      upstream:
        description: 'ì›ë³¸ ì €ì¥ì†Œ'
        required: false
        default: K-PaaS-Team22/shelter-web
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  DEFAULT_UPSTREAM: K-PaaS-Team22/shelter-web

jobs:
  sync:
    runs-on: ubuntu-latest
    # í¬í¬ì—ì„œë§Œ ì‹¤í–‰ (ì›ë³¸ì´ë©´ ìŠ¤í‚µ)
    if: ${{ github.event.repository.fork == true }}

    steps:
      - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git ì„¤ì •
        run: |
          git config --global user.name "ìë™ ì‹±í¬ ë´‡"
          git config --global user.email "auto-sync@github.com"

      - name: upstream ì›ë³¸ ìë™ íƒì§€
        id: detect
        shell: bash
        run: |
          set -e

          # 1) ì´ë²¤íŠ¸ ì»¨í…ìŠ¤íŠ¸(parent) ì‹œë„
          UPSTREAM="${{ github.event.repository.parent.full_name }}"
          # 2) ìˆ˜ë™ ì…ë ¥(workflow_dispatch inputs) ì‹œë„
          if [ -z "$UPSTREAM" ]; then
            UPSTREAM="${{ inputs.upstream }}"
          fi
          # 3) GitHub REST APIë¡œ parent ì¡°íšŒ(ì»¨í…ìŠ¤íŠ¸ì— ì—†ì„ ìˆ˜ ìˆìŒ)
          if [ -z "$UPSTREAM" ]; then
            if command -v gh >/dev/null 2>&1; then
              UP=$(gh api repos/${{ github.repository }} --jq '.parent.full_name' 2>/dev/null || true)
              if [ -n "$UP" ] && [ "$UP" != "null" ]; then
                UPSTREAM="$UP"
              fi
            fi
          fi
          # 4) ìµœí›„ì˜ ê¸°ë³¸ê°’(í™˜ê²½ë³€ìˆ˜)
          if [ -z "$UPSTREAM" ]; then
            UPSTREAM="${DEFAULT_UPSTREAM}"
          fi

          if [ -z "$UPSTREAM" ]; then
            echo "âŒ ì›ë³¸ ì €ì¥ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. workflow_dispatch ì…ë ¥ê°’ ë˜ëŠ” env.DEFAULT_UPSTREAMì„ ì„¤ì •í•˜ì„¸ìš”."
            exit 1
          fi

          echo "ğŸ” ê°ì§€ëœ upstream: $UPSTREAM"
          echo "upstream=$UPSTREAM" >> "$GITHUB_OUTPUT"

      - name: upstream ë¦¬ëª¨íŠ¸ ì¶”ê°€/ê°€ì ¸ì˜¤ê¸°
        run: |
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "https://github.com/${{ steps.detect.outputs.upstream }}.git"
          git fetch upstream --prune

      - name: main ë¸Œëœì¹˜ ì‹±í¬
        shell: bash
        run: |
          set -e
          git checkout main
          git merge upstream/main --no-edit || exit 1

          if ! git diff --quiet origin/main..HEAD; then
            git push origin main
            echo "âœ… main ë¸Œëœì¹˜ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "â„¹ï¸ main ë¸Œëœì¹˜ëŠ” ì´ë¯¸ ìµœì‹ ì…ë‹ˆë‹¤"
          fi

      - name: develop ë¸Œëœì¹˜ ì‹±í¬ (ì„ íƒ)
        shell: bash
        run: |
          set -e
          if git show-ref --verify --quiet refs/remotes/upstream/develop; then
            if git show-ref --verify --quiet refs/heads/develop; then
              git checkout develop
              git merge upstream/develop --no-edit || exit 1
            else
              git checkout -b develop upstream/develop
            fi

            if ! git diff --quiet origin/develop..HEAD; then
              git push origin develop
              echo "âœ… develop ë¸Œëœì¹˜ ë™ê¸°í™” ì™„ë£Œ"
            else
              echo "â„¹ï¸ develop ë¸Œëœì¹˜ëŠ” ì´ë¯¸ ìµœì‹ ì…ë‹ˆë‹¤"
            fi
          else
            echo "â„¹ï¸ upstreamì— develop ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: ìš”ì•½
        run: |
          echo "ğŸ‰ í¬í¬ ì‹±í¬ ì™„ë£Œ"
          echo "ğŸ“… ì™„ë£Œ ì‹œê°: $(date)"
          echo "ğŸ”„ ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --pretty=format:'%h - %s (%an, %ar)')"
