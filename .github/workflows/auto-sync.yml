name: Auto Sync Fork with Upstream

on:
  push:
    branches:
      - main
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.repository.fork == true && github.repository == 'K-PaaS-Team22/shelter-web'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "Auto Sync Bot"
          git config --global user.email "auto-sync@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ github.event.repository.parent.full_name || github.repository_owner }}/${{ github.event.repository.name }}.git
          git fetch upstream

      - name: Sync main branch
        run: |
          git checkout main
          git merge upstream/main --no-edit

          # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ í‘¸ì‹œ
          if ! git diff --quiet HEAD~1 HEAD; then
            git push origin main
            echo "âœ… Successfully synced with upstream"
          else
            echo "â„¹ï¸ Already up to date"
          fi

      - name: Sync other branches (optional)
        run: |
          # develop ë¸Œëœì¹˜ê°€ ìˆë‹¤ë©´ ì‹±í¬
          if git show-ref --verify --quiet refs/remotes/upstream/develop; then
            if git show-ref --verify --quiet refs/heads/develop; then
              git checkout develop
              git merge upstream/develop --no-edit
              git push origin develop
              echo "âœ… develop ë¸Œëœì¹˜ ì‹±í¬ ì™„ë£Œ"
            else
              git checkout -b develop upstream/develop
              git push origin develop
              echo "âœ… develop ë¸Œëœì¹˜ ìƒì„± ë° ì‹±í¬ ì™„ë£Œ"
            fi
          else
            echo "â„¹ï¸ upstreamì— develop ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: Sync summary
        run: |
          echo "ğŸ‰ í¬í¬ ì‹±í¬ ì‘ì—… ì™„ë£Œ!"
          echo "ğŸ“… ì™„ë£Œ ì‹œê°„: $(date)"
          echo "ğŸ”„ ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --pretty=format:'%h - %s (%an, %ar)')"
