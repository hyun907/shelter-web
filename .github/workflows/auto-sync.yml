name: í¬í¬ ìë™ ì‹±í¬

on:
  workflow_dispatch:          # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]        # ë‚´ í¬í¬ mainì— push ë  ë•Œë„ ì‹¤í–‰

permissions:
  contents: write             # push ê¶Œí•œ í•„ìš”

jobs:
  sync:
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork == true }}

    steps:
      - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git ì„¤ì •
        run: |
          git config --global user.name "ìë™ ì‹±í¬ ë´‡"
          git config --global user.email "auto-sync@github.com"

      - name: upstream ì›ë³¸ ì¶”ê°€
        run: |
          UPSTREAM="${{ github.event.repository.parent.full_name }}"
          if [ -z "$UPSTREAM" ]; then
            echo "âŒ ì›ë³¸ ì €ì¥ì†Œ(parent)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í¬í¬ê°€ ë§ë‚˜ìš”?"
            exit 1
          fi
          git remote add upstream "https://github.com/$UPSTREAM.git"
          git fetch upstream --prune

      - name: main ë¸Œëœì¹˜ ì‹±í¬
        run: |
          git checkout main
          git merge upstream/main --no-edit || exit 1

          if ! git diff --quiet origin/main..HEAD; then
            git push origin main
            echo "âœ… main ë¸Œëœì¹˜ê°€ ì›ë³¸ê³¼ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "â„¹ï¸ main ë¸Œëœì¹˜ëŠ” ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤."
          fi

      - name: develop ë¸Œëœì¹˜ ì‹±í¬ (ì„ íƒ)
        run: |
          if git show-ref --verify --quiet refs/remotes/upstream/develop; then
            if git show-ref --verify --quiet refs/heads/develop; then
              git checkout develop
              git merge upstream/develop --no-edit || exit 1
            else
              git checkout -b develop upstream/develop
            fi

            if ! git diff --quiet origin/develop..HEAD; then
              git push origin develop
              echo "âœ… develop ë¸Œëœì¹˜ê°€ ì›ë³¸ê³¼ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "â„¹ï¸ develop ë¸Œëœì¹˜ëŠ” ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤."
            fi
          else
            echo "â„¹ï¸ ì›ë³¸ ì €ì¥ì†Œì—ëŠ” develop ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ìš”ì•½
        run: |
          echo "ğŸ‰ í¬í¬ ì‹±í¬ ì™„ë£Œ!"
          echo "ğŸ“… ì™„ë£Œ ì‹œê°: $(date)"
          echo "ğŸ”„ ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --pretty=format:'%h - %s (%an, %ar)')"
